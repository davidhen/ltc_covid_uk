---
title: "Derived data"
author: "David Henderson"
date: "13/07/2020"
output: 
  html_document:
    theme: journal
    highlight: haddock
    df_print: paged
    code_folding: hide
    toc: yes
    toc_float: yes
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 12, fig.height = 9,
                      warning = FALSE, message = FALSE)
```

# Introduction

There are issues with uploading raw data to RStudio.cloud. As a work around I am going to create a simplified data object to create the care home size boxplot. This is a hacky workaround.  

**Note, this RMD won't knit in RStudio cloud or on any machine other than David Henderson's. The raw data files are too big for Rstudio.cloud to handle so I ran this code locally and saved smaller data objects that could be imported into the `ltc_covid_uk.Rmd` file from the `derived_data` folder. As I said - pretty hacky**

## Packages

R packages required.....

```{r}
library(tidyverse)
library(curl)
library(readxl)
library(forcats)
library(ggthemes)
library(here)
#Helper function
`%nin%` <- negate(`%in%`)

#Short cut for csv output with html tables
my_datatable <- function(x){
  DT::datatable(x, extensions = "Buttons", options = list(dom = "Bfrtip", 
                                                          buttons = c("csv")))
}
```


# Care Home size


```{r}
eng <- read_xlsx("raw_data/ENGLAND_care_homes.xlsx", sheet = "HSCA Active Locations")
scot <- read_xlsx("raw_data/SCOTLAND_care_homes.xlsx", sheet = "MDSF_data_31 May 2020")
ni <- read_xlsx("raw_data/NI_care_homes.xlsx")
w <- read_xlsx("raw_data/22 - CIW - 20200730 - list of adult care homes in Wales.xlsx", 
               range = "A4:K1060")
```

```{r}
eng %<>% 
  filter(`Care home?` == "Y" & 
           `Location Inspection Directorate` == "Adult social care") %>% 
  select(`Location Name`, `Care homes beds`, `Service user band - Older People`) %>%
  #filter(!is.na(`Service user band - Older People`))
  mutate(country = "England")
eng
```

```{r}
scot %<>% 
  filter(CareService == "Care Home Service" & 
           Subtype %nin% c("Children & Young People" ) &
           ServiceStatus == "Active") %>% 
  select(`Location Name` = ServiceName, 
         `Care homes beds` = TotalBeds, Subtype) %>% 
  mutate(country = "Scotland")
scot
```

```{r}
ni %<>% 
  filter(Category %in% c("Nursing (NH)", "Residential (RC)")) %>% 
  select(`Location Name` = ServiceName,
         `Care homes beds` = `Max Approved Places`,
         `Categories of Care`) %>% 
  mutate(country = "Northern Ireland")
ni
```

```{r}
w %<>% 
  select(`Location Name` = `Service Name`,
         `Care homes beds` = `Maximum Capacity`,
         `Service Sub Type`) %>% 
  mutate(country = "Wales")
w  
```




```{r}
uk <- bind_rows(eng, scot, w, ni) %>% 
  mutate(country = factor(country,
                          levels = c("England", "Scotland", "Wales", "Northern Ireland")))
uk
```

```{r}
feather::write_feather(uk, "derived_data/uk.feather")
```

