---
title: "UK comparison"
author: "David Henderson"
date: "13/07/2020"
output: 
  html_document:
    theme: journal
    highlight: haddock
    df_print: paged
    code_folding: hide
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 12, fig.height = 9,
                      warning = FALSE, message = FALSE)
```

# Introduction

1st attempt to combine data from all 4 UK nations to look at excess deaths in 2020 by week and location of death. The main idea of this file is to show co-authors what we are hoping to get as an output. This may not be possible. As you will see here, the data for E & W is combined and we don't have NI data yet. 

## Packages

R packages required.....

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(curl)
library(readxl)
library(lubridate)
library(forcats)
library(patchwork)
library(ggthemes)

#Helper function
`%nin%` <- negate(`%in%`)

#Short cut for csv output with html tables
my_datatable <- function(x){
  DT::datatable(x, extensions = "Buttons", options = list(dom = "Bfrtip", 
                                                          buttons = c("csv")))
}

#Baseline plot settings
theme_set(theme_minimal(base_family = "Roboto", base_size = 20) +
            theme(panel.grid.minor = element_blank(),
                  axis.title.y = element_text(margin = margin(0, 20, 0, 0)),
                  axis.title.x = element_text(margin = margin(20, 0, 0, 0)),
                  plot.caption = element_text(colour = "#AAAAAA"),
                  plot.margin = margin(3,15,3,3,"mm")))

#global options for scientific numbers and significant digits.          
options(scipen = 10,
        digits = 1)
```


# England data

Data provided sourced from [here](https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/causesofdeath/datasets/deathregistrationsandoccurrencesbylocalauthorityandhealthboard) and [here](https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/adhocs/11826fiveyearaverageweeklydeathsbylocalauthorityandplaceofoccurrenceenglandandwalesdeathsregistered2015to2019) and collated into `.csv` files by Pietro. I have saved this file in the `excess_mort_data` folder.

```{r}
england <- read_csv("excess_mort_data/Weekly Summary England.csv")

england %<>% 
  slice(-1) %>% 
  select(location,
         week_number = `week number`,
         all = `all deaths`,
         non_covid, covid, 
         average = `average 2015-2019`,
         excess = `excess deaths`, 
         country) %>% 
  mutate(location = factor(location,
                           levels = c("Hospital", "Care Home", "Home", "Other"),
                           labels = c("Hospital", "Care Home", "Home", "Other"))) %>% 
  mutate_at(.vars = c("week_number", "all", "covid"), as.integer)

england
```

# Scotland data

This comes from two files on the NRS site. One has weekly COIVD and all-cause deaths, the other the weekly numbers (including averages) for the previous 5 years.

```{r, warning=FALSE, message=FALSE}
temp_1 <- tempfile()
temp_2 <- tempfile()
source <- "https://www.nrscotland.gov.uk/files//statistics/covid19/covid-deaths-data-week-26.zip"

temp_1 <- curl_download(url = source, destfile = temp_1, quiet = FALSE)
unzip(temp_1, exdir = temp_2)

ch_death_covid <- read_csv(file.path(temp_2,"covid-deaths-data-week-26_Table 1 - COVID deaths.csv"), skip = 3)
ch_death_all <- read_csv(file.path(temp_2, "covid-deaths-data-week-26_Table 2 - All deaths.csv"), skip = 3)
#5 year average can be downladed directly from this link...
ch_death_average <- read_csv("https://www.nrscotland.gov.uk/files//statistics/covid19/weekly-deaths-by-location-2015-2019.csv", skip = 2)

#Now tidy and join together

loc_names <- c("Care Home", "Home and other non institution", "Hospital",
          "Other institution")

# Create a look-up table for week numbers to dates
week_lookup <- tibble(
  week_number = 1:52,
  week_date = seq(ymd(20191230), ymd(20201221), by = "1 week"))


#Wrangle Average deaths
ch_death_average %>% 
  slice(2:6, 9:13, 16:20, 23:27) %>% 
  mutate(location = rep(loc_names, each = 5, times = 1)) %>% 
  select(year = `Week number2`, location, everything(), -`53`) %>% 
  pivot_longer(cols = `1`:`52`, names_to = "week_number",
               values_to = "n_deaths") %>% 
  group_by(location, week_number) %>%
  mutate(min_deaths = min(n_deaths),
         max_deaths = max(n_deaths),
         mean_deaths = mean(n_deaths)) %>% 
  distinct(location, week_number, .keep_all = TRUE) %>% 
  select(-year, -n_deaths) %>% 
  ungroup %>% 
  mutate(week_number = as.integer(week_number)) -> sc

#Wrangle all deaths
ch_death_all %>% 
  select(location = X2, everything(), -`Week beginning`, -X30:-X65) %>% 
  slice(85:88) %>%  
  mutate_at(vars(`30-Dec-19`:`22-Jun-20`), as.numeric) %>% 
  pivot_longer(cols = `30-Dec-19`:`22-Jun-20`, names_to = "date",
               values_to = "deaths_all_2020") %>% 
  mutate(date = dmy(date),
         week_number = rep(1:26, each = 1, times = 4),
         location = rep(loc_names, each = 26, times = 1)) %>% 
  select(-date) %>% 
  left_join(sc, .) -> sc


#Wrangle Covid deaths and join together
ch_death_covid %>% 
  select(location = X2, everything(), -`Week beginning`,
         -`Year to Date`:-X44) %>% 
  slice(83:86) %>%  
  pivot_longer(cols = `30-Dec-19`:`22-Jun-20`, names_to = "date",
               values_to = "deaths_covid_2020") %>% 
  mutate(date = dmy(date),
         week_number = rep(1:26, each = 1, times = 4),
         location = rep(loc_names, each = 26, times = 1)) %>% 
  select(-date) %>% 
  left_join(sc, .) %>% 
  mutate(deaths_nonCovid_2020 = deaths_all_2020 - deaths_covid_2020,
         location = factor(location,
                           levels = c("Hospital", "Care Home", 
                                      "Home and other non institution", 
                                      "Other institution"),
                           labels = c("Hospital", "Care Home", "Home", "Other"))) %>% 
  left_join(., week_lookup) %>% 
  filter(week_number >=11 & week_number <= 26) %>% 
  select(-min_deaths, -max_deaths, -X29, -week_date) %>% 
  rename(all = deaths_all_2020,
         covid = deaths_covid_2020,
         non_covid = deaths_nonCovid_2020,
         average = mean_deaths) %>% 
  mutate(excess = all - average,
         country = "Scotland") -> sc

sc
```

# Wales

Same source as England data. Also wrangled into a `.csv` by Pietro.

```{r}
wales <- read_csv("excess_mort_data/Weekly Summary Wales.csv")

wales %<>% 
  slice(-1) %>% 
  select(location,
         week_number = `week number`,
         all = `all deaths`,
         non_covid, covid, 
         average = `average 2015-2019`,
         excess = `excess deaths`, 
         country) %>% 
  mutate(location = factor(location,
                           levels = c("Hospital", "Care Home", "Home", "Other"),
                           labels = c("Hospital", "Care Home", "Home", "Other"))) %>% 
  mutate_at(.vars = c("week_number", "all", "covid"), as.integer)

wales
```




# Join together

```{r}
uk <- bind_rows(england, sc, wales)

uk %>%
  mutate(country = factor(country, 
                          levels = c("England", "Scotland", "Wales"))) -> uk
```

# Plot

This is the sort of plot we want as an end result, but with 4 nations....

```{r}
fig_uk_excess_1 <- 
  uk %>% 
  mutate(pct_change = (excess / average * 100)) %>% 
  ggplot(aes(week_number, pct_change, fill = country)) +
  geom_col() +
  facet_grid(location~country) +
  scale_fill_wsj() +
  scale_y_continuous(limits = c(-50, 300),
                     labels = scales::percent_format(scale = 1)) +
  theme(legend.position = "none") +
  labs(title = "by Location and Week",
       x = "Week Number",
       y = "")#,
       #caption = "Source: ONS & NRS\nCode:https://github.com/davidhen/ltc_covid_uk/blob/master/excess_mort_plot.Rmd")
fig_uk_excess_1
```


```{r, echo=FALSE, eval=FALSE}
ggsave("plots/fig_uk_excess.png", fig_uk_excess, width = 12, height = 9, dpi = 300)
```


```{r, fig.width=12, fig.height=6}
fig_excess_uk_2 <-
  uk %>% 
  group_by(country, location) %>% 
  summarise(all = sum(all), 
            average = sum(average),
            excess = all - average,
            pct_change = excess / average * 100) %>% 
  ggplot(aes(country, pct_change, fill = country)) +
  geom_col() +
  facet_grid(~location) +
  scale_fill_wsj() +
  scale_y_continuous(limits = c(-20,80),
                     labels = scales::percent_format(scale = 1),
                     breaks = scales::pretty_breaks()) +
  theme(legend.position = "top",
        axis.text.x = element_blank()) +
  labs(title = "by Location",
       x = "",
       y = "",
       fill = "")
fig_excess_uk_2
```



```{r}
fig_excess_uk_2 + fig_uk_excess_1 +
  plot_annotation(title = "Excess mortality in the UK 2020",
                  subtitle = "by Location of death",
                  caption = "Source: ONS & NRS\nCode:https://github.com/davidhen/ltc_covid_uk/blob/master/excess_mort_plot.Rmd") +
  plot_layout(widths = c(1,1.1)) -> uk_excess_comb
uk_excess_comb
```

```{r, echo=FALSE, eval=FALSE}
ggsave("plots/uk_excess_comb.png", uk_excess_comb, width = 24, height = 12, dpi = 300)
```



```{r}
uk %>% 
  group_by(country) %>% 
  summarise(all = sum(all), 
            average = sum(average),
            excess = all - average,
            pct_change = excess / average * 100) %>% 
  ggplot(aes(country, pct_change, fill = country)) +
  geom_col() +
  scale_fill_wsj() +
  scale_y_continuous(limits = c(0,40),
                     labels = scales::percent_format(scale = 1)) +
  theme(legend.position = "none") +
  labs(title = "Overall",
       x = "",
       y = "",
       caption = "") -> uk_excess
uk_excess
```

```{r, echo=FALSE, eval=FALSE}
ggsave("plots/uk_excess.png", uk_excess, width = 12, height = 9, dpi = 300)
```

```{r, fig.width=14, fig.height=14}
(uk_excess + fig_excess_uk_2) / fig_uk_excess_1 +
  plot_annotation(title = "",
                  subtitle = "",
                  caption = "Source: ONS & NRS\nCode:https://github.com/davidhen/ltc_covid_uk/blob/master/excess_mort_plot.Rmd") +
  plot_layout(heights = c(1, 1.2))-> uk_excess_comb
uk_excess_comb
```

```{r, echo=FALSE, eval=FALSE}
ggsave("plots/uk_excess_comb.png", uk_excess_comb, width = 18, height = 18, dpi = 300)
```



# Data table

Click on the CSV button to download the wrangeled dataset..

```{r}
my_datatable(uk)
```


