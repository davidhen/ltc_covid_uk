---
title: "UK comparison"
author: "David Henderson"
date: "13/07/2020"
output: 
  html_document:
    theme: journal
    highlight: haddock
    df_print: paged
    code_folding: hide
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 12, fig.height = 9,
                      warning = FALSE, message = FALSE)
```

# Introduction

Code to produce figures with the report COVID-19 mortality and long term care: a UK comparison
Wizzy woz here

Hedge is changing this

## Packages

R packages required.....

```{r}
library(tidyverse)
library(curl)
library(readxl)
library(lubridate)
library(forcats)
library(patchwork)
library(ggthemes)
library(here)
#Helper function
`%nin%` <- negate(`%in%`)

#Short cut for csv output with html tables
my_datatable <- function(x){
  DT::datatable(x, extensions = "Buttons", options = list(dom = "Bfrtip", 
                                                          buttons = c("csv")))
}

#Baseline plot settings
theme_set(theme_minimal(base_family = "Roboto", base_size = 20) +
            theme(panel.grid.minor = element_blank(),
                  axis.title.y = element_text(margin = margin(0, 20, 0, 0)),
                  axis.title.x = element_text(margin = margin(20, 0, 0, 0)),
                  plot.caption = element_text(colour = "#AAAAAA"),
                  plot.margin = margin(3,15,3,3,"mm")))

#global options for scientific numbers and significant digits.          
options(scipen = 10,
        digits = 1)
```


## Data

```{r, message=FALSE, warning=FALSE}
#Assign url and download into a temp file
url <- "https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2020/publishedweek282020.xlsx"
temp <- tempfile()
temp <- curl_download(url=url, destfile=temp, quiet=FALSE)


#Extract weekly data for each country from "UK" Worksheet and tidy up
uk_deaths_data <-
  read_xlsx(temp, sheet="UK - Covid-19 - Weekly reg", 
                         range = "A4:AB12") %>% 
  slice(5:8) %>% 
  select(-`Week number`) %>% 
  rename(country = `...2`) %>% 
  pivot_longer(`1`:`26`, names_to = "week_number", 
               values_to = "covid_deaths") %>% 
  mutate(week_number = as.integer(week_number)) %>% 
  filter(week_number >= 11) %>% 
  mutate(country = factor(country, 
                          levels = c("England", "Scotland", 
                          "Wales", "Northern Ireland")),
         pop = case_when(
           country == "England" ~ 56286961,
           country == "Wales" ~ 3152879,
           country == "Scotland" ~ 5463300,
           country == "Northern Ireland" ~ 1893667),
    deaths_100000 = covid_deaths/pop * 100000)

uk_deaths_data
```


# Figure 1 Overall deaths

```{r}
uk_deaths_data %>% 
  group_by(week_number) %>% 
  summarise(tot_deaths = sum(covid_deaths)) %>% 
  ggplot(aes(week_number, tot_deaths)) +
  geom_line(colour = ptol_pal()(1)) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 12)) +
  scale_y_continuous(breaks = scales::pretty_breaks(),
                     limits = c(0, 10000)) +
  labs(x = "Week number",
       y = "") -> fig_1
fig_1
```

```{r, echo=FALSE, eval=FALSE}
ggsave("plots/fig_1.png", fig_1, width = 12, height = 9, dpi = 300)
```


# Figure 2

```{r}
uk_deaths_data %>% 
  ggplot(aes(week_number, deaths_100000, colour = country)) +
  geom_line(size = 1.2) +
  scale_colour_ptol() +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 12)) +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  theme(legend.position = "top") +
  labs(x = "Week number",
       y = "", 
       colour = "") -> fig_2
fig_2
```

```{r, echo=FALSE, eval=FALSE}
ggsave("plots/fig_2.png", fig_2, width = 12, height = 9, dpi = 300)
```



# Figure 3

```{r}
url <- "https://www.nrscotland.gov.uk/files//statistics/covid19/weekly-deaths-by-location-age-group-sex.xlsx"
temp <- tempfile()
temp <- curl_download(url=url, destfile=temp, quiet=FALSE)

#tidy up
scot_deaths_data <-
  read_xlsx(temp, sheet="Data", 
            range = "A3:F1229") %>% 
  rename(week = 'Registration Week') %>% 
  rename(covid_death = 'Cause of Death') %>% 
  rename(age_band = 'Age band') %>% 
  mutate(week = as.integer(week)) %>% 
  filter(week >= 11) %>% 
  filter(Location == "Care Home")%>% 
  filter(covid_death == "COVID-19")

scot_deaths_data %>% 
  group_by(age_band) %>% 
  summarise(tot_deaths = sum(Deaths)) %>% 
  ggplot(aes(age_band,tot_deaths)) +
  geom_col(fill = ptol_pal()(1))+
  labs(x = "Age Band",
       y = "") -> fig_3
fig_3

```


```{r, echo=FALSE, eval=FALSE}
ggsave("plots/fig_3.png", fig_3, width = 12, height = 9, dpi = 300)
```



# Figure 4
## Load in data
Data created in "care_inspectorate_wrangle.Rmd" file

```{r}
uk <- feather::read_feather("derived_data/uk.feather")
```

## Plot all care homes


```{r}
uk %>% 
  ggplot(aes(fct_rev(country), `Care homes beds`, colour = country)) +
  geom_violin(alpha = 0.5) +
  geom_boxplot(width = 0.2) +
  scale_colour_ptol() +
  theme(legend.position = "none",
        plot.caption = element_text(size = 12)) +
  coord_flip() +
  labs(x = "",
       y = "Number of care home beds",
       caption = "Outer line indicates distribution\nStrong vertical line in box indicates the median\nBox limits indicate 25th and 75th percentile\nDots indicate statistical outliers") -> fig_4
fig_4
```

```{r, echo=FALSE, eval=FALSE}
ggsave("plots/fig_4.png", fig_4, width = 12, height = 9, dpi = 300)
```


# Figure 5

Plot older people only

```{r}
uk %>% 
  filter(country %nin% c("Northern Ireland", "Wales")) %>% 
  filter(`Service user band - Older People` == "Y" | Subtype == "Older People") %>% 
  ggplot(aes(fct_rev(country), `Care homes beds`, colour = country)) +
  geom_violin(alpha = 0.5) +
  geom_boxplot(width = 0.2) +
  scale_colour_ptol() +
  theme(legend.position = "none",
        plot.caption = element_text(size = 12)) +
  coord_flip() +
  labs(x = "",
       y = "Number of care home beds",
       caption = "Outer line indicates distribution\nStrong vertical line in box indicates the median\nBox limits indicate 25th and 75th percentile\nDots indicate statistical outliers") -> fig_5
fig_5
```

```{r, echo=FALSE, eval=FALSE}
ggsave("plots/fig_5.png", fig_5, width = 12, height = 9, dpi = 300)
```

# Table 1


```{r}
uk %>% 
  group_by(country) %>% 
  summarise(n_adult_care_homes = n(), 
            total_beds = sum(`Care homes beds`, na.rm = TRUE),
            median_number_of_beds = median(`Care homes beds`, na.rm = TRUE),
            IQR_beds = IQR(`Care homes beds`, na.rm = TRUE)) -> all_beds
```


```{r}
uk %>% 
  filter(country %nin% c("Northern Ireland", "Wales")) %>% 
  filter(`Service user band - Older People` == "Y" | Subtype == "Older People") %>%
  group_by(country) %>% 
  summarise(n_adult_care_homes_older_people = n(), 
            total_beds_older_people = sum(`Care homes beds`, na.rm = TRUE),
            median_number_of_beds_older_people = median(`Care homes beds`, na.rm = TRUE),
            IQR_beds_older_people = IQR(`Care homes beds`, na.rm = TRUE)) -> older_beds
```


```{r}
full_join(all_beds, older_beds) %>% 
  pivot_longer(cols = c(2:9), names_to = "measure", values_to = "value") %>% 
  pivot_wider(names_from = "country", values_from = "value") %>% 
  rowwise() %>% 
  mutate(Total = sum(c(England, Scotland, `Northern Ireland`))) %>% 
  my_datatable(.)
```

**Need to check these numbers** Scotland & Wales with same number of care homes???

